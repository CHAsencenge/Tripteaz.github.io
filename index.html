<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>CHAsencenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="CHAsencenge">
<meta property="og:url" content="https://chasencenge.github.io/Tripteaz.github.io/index.html">
<meta property="og:site_name" content="CHAsencenge">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="CHAsencenge">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/Tripteaz.github.io/atom.xml" title="CHAsencenge" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/Tripteaz.github.io/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/Tripteaz.github.io/css/style.css">

  
    
<link rel="stylesheet" href="/Tripteaz.github.io/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/Tripteaz.github.io/" id="logo">CHAsencenge</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/Tripteaz.github.io/">Home</a>
        
          <a class="main-nav-link" href="/Tripteaz.github.io/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/Tripteaz.github.io/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://chasencenge.github.io/Tripteaz.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Essay/CD_JH_204" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Tripteaz.github.io/2023/01/10/Essay/CD_JH_204/" class="article-date">
  <time class="dt-published" datetime="2023-01-10T01:15:22.000Z" itemprop="datePublished">2023-01-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/Tripteaz.github.io/categories/Essay/">Essay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/Tripteaz.github.io/2023/01/10/Essay/CD_JH_204/">CD_JH_204</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        Here's something encrypted, password is required to continue reading.
        
          <p class="article-more-link">
            <a href="/Tripteaz.github.io/2023/01/10/Essay/CD_JH_204/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://chasencenge.github.io/Tripteaz.github.io/2023/01/10/Essay/CD_JH_204/" data-id="clcpl09vp0000gsyp13c88cm0" data-title="CD_JH_204" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Essay/CD_JH_207" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Tripteaz.github.io/2023/01/07/Essay/CD_JH_207/" class="article-date">
  <time class="dt-published" datetime="2023-01-07T06:48:11.000Z" itemprop="datePublished">2023-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/Tripteaz.github.io/categories/Essay/">Essay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/Tripteaz.github.io/2023/01/07/Essay/CD_JH_207/">CD_JH_207</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        Here's something encrypted, password is required to continue reading.
        
          <p class="article-more-link">
            <a href="/Tripteaz.github.io/2023/01/07/Essay/CD_JH_207/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://chasencenge.github.io/Tripteaz.github.io/2023/01/07/Essay/CD_JH_207/" data-id="clcpl09vt0002gsyp6bhoghrz" data-title="CD_JH_207" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Essay/CD_JH_208" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Tripteaz.github.io/2023/01/05/Essay/CD_JH_208/" class="article-date">
  <time class="dt-published" datetime="2023-01-05T10:28:13.000Z" itemprop="datePublished">2023-01-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/Tripteaz.github.io/categories/Essay/">Essay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/Tripteaz.github.io/2023/01/05/Essay/CD_JH_208/">CD_JH_208</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        Here's something encrypted, password is required to continue reading.
        
          <p class="article-more-link">
            <a href="/Tripteaz.github.io/2023/01/05/Essay/CD_JH_208/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://chasencenge.github.io/Tripteaz.github.io/2023/01/05/Essay/CD_JH_208/" data-id="clcj05lyd0000voypguns45q0" data-title="CD_JH_208" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Math/LA_游戏数学之LinearAlgebra（一）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2023-01-04T07:03:01.000Z" itemprop="datePublished">2023-01-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/Tripteaz.github.io/categories/Math/">Math</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/">【Math】 游戏数学之Linear Algebra（一）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>当你发现自己一进游戏世界就找不到北的时候，你心里就该清楚这点了，欠下线代大爹的债死也不还总是要还的。</p>
</blockquote>
<h2 id="右手系和左手系"><a href="#右手系和左手系" class="headerlink" title="右手系和左手系"></a>右手系和左手系</h2><p>这个找不到北的问题的起点，可能要从坐标系说起，左手系和右手系的区别在于它们笛卡尔坐标轴中有一个轴的方向是不同的（在游戏中通常为z轴），一个判断左手系和右手系的方法，拇指食指中指三者两两呈90°摆好，看看哪个手对的上。</p>
<p>一般的设定是，中指为x轴向右，拇指为y轴向上，这样你会发现左手系中食指的指向（z轴正向）是向远离你的方向，右手系中是接近你的方向。</p>
<p>好的，这样单纯在自己的视角上，算是找得到北了。</p>
<h2 id="矢量运算"><a href="#矢量运算" class="headerlink" title="矢量运算"></a>矢量运算</h2><ul>
<li>矢量和标量的乘法</li>
</ul>
<p>可以把相乘的标量当作缩放因子，矢量<strong>n，</strong>标量a，a<strong>n</strong> &#x3D; (axnx ,ayny, aznz)，如果a中的每个分量值不同，这种缩放称为非统一缩放。</p>
<ul>
<li>矢量的加减法</li>
</ul>
<p>矢量的加减法将矢量中每个分量分别相加&#x2F;减即可。</p>
<ul>
<li>矢量的模</li>
</ul>
<p>用于求长度。</p>
<p>矢量运算可以用于人物移动，根据本帧位置和速度求人物下一帧位置；还可用于物体的碰撞&#x2F;相交检测（矢量减法再求模）。</p>
<h2 id="矢量的点积和叉积"><a href="#矢量的点积和叉积" class="headerlink" title="矢量的点积和叉积"></a>矢量的点积和叉积</h2><ul>
<li>点积有什么用处</li>
</ul>
<p>当点积中一个矢量是单位向量时，所得值为另一矢量在该单位向量方向上的投影长度。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear0.png" class>



<p>利用点积，可以判定两矢量的方向大致在什么样的相对方向上。所得值大于零的话，二者夹角小于90°，反之大于90°（分别对应下图的红色部分和蓝色部分），等于零时二者方向垂直。更多的，还可以判断是否共线或反向共线。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear1.png" class>



<p>应用的话，你可以考虑这样的功能：当你要实现TPS游戏中的“自由视角”功能时（自由视角是指切换成此类视角时，人物呈原地站立状，鼠标的移动不再和人物的视角方向绑定，通过鼠标的移动，你可以环绕地观察自身角色，当镜头朝向人物时，人物的视线会注视向镜头的方向），为了写镜头在人身后和在前面面向人物的不同逻辑，可以用点积判断二者的相对角度并分写逻辑。</p>
<p>具体来说，人物位置<strong>P</strong>，相机位置<strong>C，</strong>人物朝向<strong>f</strong>，<strong>C - P</strong>得到人物至相机的矢量，再点积人物朝向<strong>f</strong>。</p>
<ul>
<li>关于叉积</li>
</ul>
<p>叉积的方向垂直于相乘的两个矢量构成的平面，模为|<strong>a</strong>||<strong>b</strong>|sinθ，叉积模的值等于两矢量构成的平行四边形的面积，叉积可以用于求平面的法矢量。</p>
<p>要注意的是叉积的方向会根据坐标系的选择而改变，当使用右手坐标系时，叉积方向的判断使用右手法则，左手坐标系时使用左手法则。</p>
<p>以右手法则举例，四指指向<strong>a</strong>的方向，然后四指向<strong>b</strong>的方向弯曲，拇指的方向就是叉积的方向。</p>
<h2 id="点和矢量"><a href="#点和矢量" class="headerlink" title="点和矢量"></a>点和矢量</h2><p>矢量这个词有时会表示点（位置矢量），有时会表示方向矢量。</p>
<p>在点和矢量的计算中，方向和方向之间可加可减，点和方向可加减，但是点与点之间仅可相减，不可相加。</p>
<p>方向和方向相加减之后仍为方向。</p>
<p>点和方向相加减之后会得到另一个点。</p>
<p>点和点之间相减会产生一个方向矢量，但是要注意，点和点之间进行矢量相加并无意义。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear2.png" class>

<h2 id="矩阵变换"><a href="#矩阵变换" class="headerlink" title="矩阵变换"></a>矩阵变换</h2><p>矩阵的线性变换会用于平移、旋转和缩放。变换矩阵为4 x 4的矩阵，可表示任意三维变换，仿射矩阵便是一种4 x 4的变换矩阵，支持仿射变换。</p>
<p>仿射变换包括平移、旋转、缩放、切边及其任意组合得到的变换。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear3.png" class>



<p>（图片来源于网络）</p>
<p>那下面就具体看看平移、旋转、缩放是如何通过矩阵乘法实现的。</p>
<p>三维中的旋转的实现需要3 x 3矩阵，但仅3 x 3还不足以支持额外的平移，增加一个维度至4 x 4即可。</p>
<p>如果我想要把一个点向<strong>t</strong>矢量方向进行平移，只需要在矩阵的第四行修改平移因子即可。</p>
<p>想要将矢量<strong>r</strong>进行旋转时，只需乘以各个方向的旋转变换矩阵，下面列举绕x、y、z轴旋转需乘的旋转矩阵。</p>
<p>绕x轴旋转角度Φ：</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear4.png" class>



<p>绕y轴旋转角度θ：（注意绕y轴旋转矩阵的不同，此矩阵是转置的）</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear5.png" class>



<p>绕z轴旋转角度γ：</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear6.png" class>



<p>旋转矩阵的逆矩阵也是该旋转矩阵的转置矩阵，旋转矩阵的逆变换从意义上讲是反向的角度旋转。</p>
<p>缩放的实现是通过将矢量乘上一个对角矩阵（矢量是行矢量还是列矢量在实际设计过程中可根据习惯而定，各有优势，统一标准即可，如果是行矢量，旋转缩放等矩阵都采用右乘，计算顺序从左至右，反之采用左乘，计算顺序从右侧的矢量逐渐向左完成），对角矩阵的(0, 0) (1, 1) (2, 2)处的值分别为三个轴方向上的缩放因子。</p>
<p>PS：其实到现在可以发现，4 x 4仿射矩阵的最右一列均为[0, 0, 0, 1]，为了节省内存，一些游戏数学库中可能会省略这一列，使用4 x 3的仿射矩阵。</p>
<p>在坐标空间中，对一个刚体的变换的施加是对刚体中的每一点上的，例如对于一个三角形网格，对其进行的变换会施加到三角形的三个顶点上。</p>
<h2 id="模型空间"><a href="#模型空间" class="headerlink" title="模型空间"></a>模型空间</h2><p>当你设计控制人物的旋转移动时，一定会经常看到Pitch、Yaw、Roll，可能你按照经验已经知道了对于你所控制的人物，Pitch控制抬头低头这种上下的方向，Yaw会让你往侧面看，而Roll就是不太常用的“歪头杀”了，就像这样 。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear7.png" class>



<p>但总要搞清楚它们的定义是怎么来的，那就不得不用到这架小飞机了。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear8.png" class>

<p>（图片来源于网络）</p>
<p>在模型空间中，物体向前移动的方向轴叫做向前轴，向上移动的方向轴叫做向上轴，向左或向右的方向轴叫做向左&#x2F;向右轴（使用哪个取决于游戏引擎采用左手系还是右手系）。</p>
<ul>
<li><p>Pitch、Yaw、Roll三者的定义也是绑定这三种轴的，Pitch是绕向左&#x2F;向右轴旋转的角度，叫做俯仰角。</p>
</li>
<li><p>Yaw是绕向上轴旋转的角度，叫做偏航角，也是很容易理解的命名，看看你自己的方向是不是偏离了航线。</p>
</li>
</ul>
<p>Roll是绕向前轴旋转的角度，名为滚动角，这个“滚动”就是机翼的摇摆导致的机身滚动，这么看来是不是好记了很多。</p>
<h2 id="基的变更"><a href="#基的变更" class="headerlink" title="基的变更"></a>基的变更</h2><p>终于来到了“找不到北”的根源：基的变更。</p>
<p>基的变更就是指在计算机图形学中，把物体的位置、方向、缩放从某个坐标系转换到另一个坐标系中。</p>
<p>坐标系本身就是相对的，除了世界空间，其他的坐标系都是相对于另外一组坐标系的，它本身也成为那个坐标系的子坐标系。</p>
<p>我想要把子空间位置矢量<strong>P</strong>c变换至父空间位置矢量<strong>P</strong>p，首先定义一个把点&#x2F;矢量从子坐标空间变换至父空间的矩阵<strong>M</strong>C-&gt;P，则<strong>P</strong>p &#x3D; <strong>P</strong>c <strong>M</strong>C-&gt;P。</p>
<p><strong>M</strong>C-&gt;P为：</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear10.png" class>



<p>其中<strong>i</strong>c、<strong>j</strong>c、<strong>k</strong>c分别为子空间x、y、z轴的单位基矢量（以父空间坐标表示），<strong>t</strong>c为子坐标系相对于父坐标系的平移。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear0.png" class>



<p>在父空间中表示上面的<strong>i</strong>c、<strong>j</strong>c可以发现它恰好对应了前面的旋转矩阵中的对应行。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/linear11.png" class>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chasencenge.github.io/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="clche85th0000s4yp240lejee" data-title="【Math】 游戏数学之Linear Algebra（一）" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Math/LA_游戏数学之LinearAlgebra（二）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%BA%8C%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2023-01-04T07:03:01.000Z" itemprop="datePublished">2023-01-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/Tripteaz.github.io/categories/Math/">Math</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%BA%8C%EF%BC%89/">【Math】 游戏数学之Linear Algebra（二）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>上一篇提到了使用矩阵变换来帮助旋转，并且4 x 4的仿射矩阵还能完成包括旋转、平移、缩放和切边及其组合在内的仿射变换。</p>
<p>功能确实是能完成，但是总觉得有些冗余，因为旋转明明只有三个自由度（偏航角Yaw、俯仰角Pitch、滚动角Roll），却用了9个浮点值去表示旋转部分，并且用矢量矩阵乘法来进行矢量的旋转需要进行三次点积计算。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%BA%8C%EF%BC%89/linear0.png" class>



<p>有没有什么更好的方法来减少浮点值的存储并且加速旋转计算呢？</p>
<p>四元数，它似乎听到了你的抱怨。</p>
<h2 id="四元数"><a href="#四元数" class="headerlink" title="四元数"></a>四元数</h2><p>先一句话概括四元数：四元数利用旋转轴方向和旋转角度来表达三维旋转，四个元素中，三个矢量一个标量。</p>
<p>具体来说，单位四元数的构成为三维矢量加上第四维的标量，矢量部分是旋转的单位轴乘以旋转半角的正弦值，标量部分是旋转半角余弦值，公式如下 。</p>
<p>q &#x3D; [<strong>q</strong>v qs] &#x3D; [<strong>a</strong>sinθ&#x2F;2 cosθ&#x2F;2] &#x3D;[qx qy qz qw]</p>
<p><strong>a</strong>就是旋转轴方向的单位矢量，θ为旋转角度（所以根据公式可以看到使用的是旋转半角θ&#x2F;2）。</p>
<p>两个旋转的合成旋转用四元数的乘积来表示，对于旋转m和旋转n，mn表示旋转n之后再旋转m，它们的乘法称为格拉斯曼积（Grassmann product），计算公式如下 。</p>
<p>mn &#x3D; (ms<strong>n</strong>v+ ns<strong>m</strong>v+<strong>m</strong>vx<strong>n</strong>v) (msns–<strong>m</strong>v · <strong>n</strong>v)</p>
<p>四元数是单位长度的，这给计算四元数的逆带来了相对更快的速度，因为四元数的共轭为 q* &#x3D; [-<strong>q</strong>v qs]，并且四元数的逆的计算为 q-1 &#x3D; q* &#x2F; |q|2，四元素的单位长度特性使得逆的计算无需除以模平方。</p>
<p>好了，到了具体的问题，<strong>怎样利用上面提到的四元数去旋转一个矢量？</strong></p>
<p>其实就两步：</p>
<ul>
<li>把你要旋转的矢量写成对应的四元数形式</li>
<li>左乘q，右乘q-1</li>
</ul>
<p>把矢量写成四元数形式只需要在他后面的标量位置添0即可，也就是这样 ：</p>
<p>v&#x3D; [<strong>v</strong>0 0] &#x3D; [vx vy vz 0]</p>
<p>左乘q，右乘q-1也就是这样：v’ &#x3D; qvq-1 &#x3D; qvq<em>（上面已经提到了，因为四元数是单位长度的，所以q</em> &#x3D; q-1）。</p>
<p>再具体一点的例子，上一篇提到了模型空间向世界空间的转换，也涉及到了旋转，那么<strong>求一下飞机飞行方向的单位矢量？</strong></p>
<p>飞机飞行的方向，自然就是它的向前方向，在飞机的模型空间中，它的向前方向是[0 0 1]，把模型空间的这个方向（先转换成对应的四元数[0 0 1 0]）转换至世界空间就需要用上面的方法左乘代表飞机定向的四元数q，右乘其逆q-1，则从模型空间的方向<strong>F</strong>M向世界空间方向<strong>F</strong>W的转变为：<strong>F</strong>W &#x3D; q<strong>F</strong>Mq-1。</p>
<h2 id="四元数和旋转矩阵"><a href="#四元数和旋转矩阵" class="headerlink" title="四元数和旋转矩阵"></a>四元数和旋转矩阵</h2><p>既然四元数扮演着和旋转矩阵相同的功能，那很容易联想到它们二者之间具有等价转换的关系，由于篇幅关系，这里仅给出从四元数转换至等价的旋转矩阵的结果。</p>
<p>设四元数q &#x3D; [x y z w]（按照上文习惯，标量放在第四位，有些学术文章中是放在首位的），对应的旋转矩阵R如 ：</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%BA%8C%EF%BC%89/linear1.png" class>

<h2 id="旋转插值"><a href="#旋转插值" class="headerlink" title="旋转插值"></a>旋转插值</h2><p>按照惯例，先放结论：<strong>四元数相比旋转矩阵，能更轻易地用LERP或者SLERP运算进行旋转插值。</strong></p>
<p>游戏场景中，旋转的插值几乎无处不在，最快速简单的方法就是套用四维矢量的线性插值（LERP）到四元数，据此，在A旋转至B点的过程中的第β个百分点的位置的四元数为：</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%BA%8C%EF%BC%89/linear2.png" class>



<p>这里在进行LERP后要注意进行归一化，因为LERP运算对四元数不保持矢量长度。</p>
<p>不过LERP虽然简单，但却有一定的缺陷，因为四元数实际上是四维超球上的点，LERP做的插值实际上是在超球的弦上进行，而不是在超球的面的大圆上进行，所以这种插值并不均匀，实际场景中的表现为：旋转在始末两端比较缓慢，而在动画的中间相对更快。</p>
<p>解决此问题的方法是使用球面线性插值（SLERP），SLERP在LERP基础上添加正余弦使得插值在四维超球面的大圆上，公式如 ：（对照上面LERP公式一同食用效果更佳）。</p>
<img src="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%BA%8C%EF%BC%89/linear3.png" class>



<p>这里两四元数之间的夹角的余弦值等于它们的四维点积：cosθ &#x3D; p · q &#x3D; pxqx + pyqy + pzqz+ pwqw，求出cosθ后便可以用反三角函数求出θ。</p>
<h2 id="最后简单总结一下"><a href="#最后简单总结一下" class="headerlink" title="最后简单总结一下"></a>最后简单总结一下</h2><ul>
<li>用四元数代替旋转矩阵进行旋转可以减少存储上的冗余，加快计算</li>
<li>四元数相比于旋转矩阵，能更容易完成游戏中的旋转插值操作（使用LERP &#x2F; SLERP）</li>
<li>SLERP能够解决LERP的非匀速旋转的问题（但实际中其实更多还是采用LERP，因为这种非匀速还可接受，而且SLERP计算开销大）</li>
<li>如果拿轴角这种表示方式（这一部分较为简单，文中没有提及）和四元数进行比较，轴角表示会更加直观，同样没有存储上的冗余，但是不能像四元数一样进行简单插值，并且轴角形式的旋转不能直接施加于点和矢量，而四元数可通过qvq-1方式完成</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chasencenge.github.io/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%BA%8C%EF%BC%89/" data-id="clche85tk0002s4ypa2sw4ecp" data-title="【Math】 游戏数学之Linear Algebra（二）" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Rendering/Co_色彩空间" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Tripteaz.github.io/2023/01/04/Rendering/Co_%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4/" class="article-date">
  <time class="dt-published" datetime="2023-01-04T06:21:39.000Z" itemprop="datePublished">2023-01-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/Tripteaz.github.io/categories/Rendering/">Rendering</a>►<a class="article-category-link" href="/Tripteaz.github.io/categories/Rendering/Theory/">Theory</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/Tripteaz.github.io/2023/01/04/Rendering/Co_%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4/">【Theory】 色彩空间</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>关于标准</strong></p>
<p>SDR通常使用sRGB&#x2F;BT.709, BT.601；HDR通常使用BT.2020, DCI-P3, sRGB(for gaming)，在DX12中体现为色彩空间枚举内容的一部分。</p>
<p><strong>Blending表现上</strong></p>
<p>Perceptual blend模仿人类对颜色的感知，平滑过渡。</p>
<p>Linear blend基于光的物理行为来混合颜色。如相机中的焦距模糊将颜色混合在一起，在远处观看两种颜色的图案。</p>
<p>sRGB blend是计算机软件中混合颜色的方式，表现上是混合时发暗发蓝，历史包袱是CRT显示器的工作方式。</p>
<p><strong>颜色感知</strong></p>
<p>需要对光谱进行复杂的非线性转换，已有相应的模型；眼睛是不能感知全光谱的光的，视锥细胞（cones）是对颜色有感知反应细胞，会对一定范围内的波长做出反应，cones依据感知波长区间敏感度来分类：长，中，短，LMS；长对应红色，中到绿色，短到蓝色（红色波长最长，蓝色最短）。</p>
<p>只要响应相同，不同光谱可以产生相同的“感知颜色”。例如，彩色显示器通过结合红色、绿色和蓝色的光产生广泛的颜色。印刷作品类似地使用青色、品红和黄色墨水，彩色涂料是通过混合各种颜料来达到所需的颜色。</p>
<p>色调、亮度、色彩等其实不是光的基本属性，它们的数值模拟是经验拟合的非线性模型。</p>
<p><strong>数学方法描述</strong></p>
<p>三种原色组合，CIE 1931 XYZ颜色空间将颜色表示为三个值:X、Y和Z。</p>
<p><strong>什么是色彩空间</strong></p>
<p>将颜色映射到数字，进行描述需要一组基色（primary color）集合，和一个非线性转换函数（transfer function）。</p>
<p>常用的Transfer function的形式是<br>$$<br>f(x) &#x3D; x^γ， γ &#x3D; 1&#x2F;2.2<br>$$<br><strong>色域&#x2F;色饱和度</strong></p>
<p>选择的原色影响了可见颜色的哪部分可被表示，能被表示的部分为色域（gamut）。</p>
<p>色域之外的许多颜色仍然是有效的颜色，它们只是不能在给定的色彩空间中进行编码。</p>
<p><strong>不能被编码的颜色</strong>可以分两类：</p>
<p>一个或多个RGB值大于1，但没有负值：这些颜色对于色彩空间来说太亮了，但是可以在较低的亮度下进行编码。</p>
<p>一个或多个负数：这些颜色比色彩空间能够编码的颜色更丰富多彩。其中一些可以是真实的颜色，但也可以是比物理可能的颜色更丰富的颜色。这是颜色线性编码的结果，它能够编码现实生活中不存在的颜色。</p>
<p>更宽的色域需要更高数据精度存储颜色，普通显示器可能无法显示所有颜色。</p>
<p><strong>色彩管理</strong></p>
<p>对色彩空间的信息进行编码，将颜色转换为设备的正确色彩空间。</p>
<p>不主动管理颜色的应用程序，sRGB已成为标准。</p>
<p><strong>色彩操作</strong></p>
<p>有意义的有三类：</p>
<p>符合真实光照和材料的行为。</p>
<p>与人对色彩感知相匹配。</p>
<p>风格化。</p>
<p><strong>色彩比较</strong></p>
<p>sRGB和Linear都不能做到和色调感知一致的有色与白色的混合。</p>
<p>混合饱和相反的颜色时，sRGB表现为变暗。</p>
<p>混合黑白，sRGB和感知色彩空间差不多。</p>
<p><strong>HSL&#x2F;HSV</strong></p>
<p>色调、饱和度、亮度&#x2F;值。</p>
<p>它们不是颜色空间，是将RGB颜色空间重新映射到更容易使用的参数的方法。</p>
<p>因此它们共享它们所基于的RGB颜色空间的属性。</p>
<p><strong>Ref：</strong></p>
<p><a target="_blank" rel="noopener" href="https://bottosson.github.io/posts/colorwrong/">How software gets color wrong</a></p>
<p><a target="_blank" rel="noopener" href="https://bottosson.github.io/posts/gamutclipping/">sRGB gamut clipping</a></p>
<p><a target="_blank" rel="noopener" href="https://indico.freedesktop.org/event/2/contributions/56/attachments/64/105/2022%20XDC%20Is%20HDR%20Harder.pdf">AMD: Is HDR Harder？</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chasencenge.github.io/Tripteaz.github.io/2023/01/04/Rendering/Co_%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4/" data-id="clche78dm00003gyp0egr11s5" data-title="【Theory】 色彩空间" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Essay/CD_JH_209" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Tripteaz.github.io/2023/01/04/Essay/CD_JH_209/" class="article-date">
  <time class="dt-published" datetime="2023-01-04T03:32:25.000Z" itemprop="datePublished">2023-01-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/Tripteaz.github.io/categories/Essay/">Essay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/Tripteaz.github.io/2023/01/04/Essay/CD_JH_209/">CD_JH_209</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        Here's something encrypted, password is required to continue reading.
        
          <p class="article-more-link">
            <a href="/Tripteaz.github.io/2023/01/04/Essay/CD_JH_209/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://chasencenge.github.io/Tripteaz.github.io/2023/01/04/Essay/CD_JH_209/" data-id="clchaxnns00009wyphwuzafyi" data-title="CD_JH_209" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Essay/CD_JH_210" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Tripteaz.github.io/2023/01/04/Essay/CD_JH_210/" class="article-date">
  <time class="dt-published" datetime="2023-01-04T03:31:50.000Z" itemprop="datePublished">2023-01-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/Tripteaz.github.io/categories/Essay/">Essay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/Tripteaz.github.io/2023/01/04/Essay/CD_JH_210/">CD_JH_210</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        Here's something encrypted, password is required to continue reading.
        
          <p class="article-more-link">
            <a href="/Tripteaz.github.io/2023/01/04/Essay/CD_JH_210/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://chasencenge.github.io/Tripteaz.github.io/2023/01/04/Essay/CD_JH_210/" data-id="clchaxnnu00019wyp4b0dgtsi" data-title="CD_JH_210" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Rendering/HZB_遮挡剔除与层次Z缓冲（上）——原理篇" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Tripteaz.github.io/2023/01/04/Rendering/HZB_%E9%81%AE%E6%8C%A1%E5%89%94%E9%99%A4%E4%B8%8E%E5%B1%82%E6%AC%A1Z%E7%BC%93%E5%86%B2%EF%BC%88%E4%B8%8A%EF%BC%89%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/" class="article-date">
  <time class="dt-published" datetime="2023-01-04T02:29:43.000Z" itemprop="datePublished">2023-01-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/Tripteaz.github.io/categories/Rendering/">Rendering</a>►<a class="article-category-link" href="/Tripteaz.github.io/categories/Rendering/Theory/">Theory</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/Tripteaz.github.io/2023/01/04/Rendering/HZB_%E9%81%AE%E6%8C%A1%E5%89%94%E9%99%A4%E4%B8%8E%E5%B1%82%E6%AC%A1Z%E7%BC%93%E5%86%B2%EF%BC%88%E4%B8%8A%EF%BC%89%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/">【Rendering】 遮挡剔除与层次Z缓冲（上）——原理篇</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <hr>
<h4 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h4><p><strong>遮挡剔除（Occlusion Culling，OC）</strong>属加速算法，用于剔除从视点看向场景时的被遮蔽的物体，减少不必要的渲染开销。</p>
<p><strong>层次Z缓冲（Hierarchical Z-Buffering，HZB）</strong>是GPU实现z-culling的硬件方法的基础。</p>
<h4 id="2-基本概念"><a href="#2-基本概念" class="headerlink" title="2. 基本概念"></a>2. 基本概念</h4><h5 id="2-1-z-buffer和z-culling"><a href="#2-1-z-buffer和z-culling" class="headerlink" title="2.1 z-buffer和z-culling"></a>2.1 z-buffer和z-culling</h5><p>在管线中，当一个物体投射到屏幕，像素深度值会和buffer中已存的深度值进行比较，这一过程叫做深度测试，若新的深度值更小，则取代buffer中的旧值。场景中所有物体会执行这一过程，得到最终更新后的z-buffer，这一过程叫做z-culling。</p>
<h5 id="2-2-depth-complexity"><a href="#2-2-depth-complexity" class="headerlink" title="2.2 depth complexity"></a>2.2 depth complexity</h5><p>指单一像素点覆盖了多少层物体表面，注意这里是surface layer的概念，例如下图中间像素的depth complexity &#x3D; 10，因为因为穿过了10个sphere的表面（假设backface culling开启，不算背面）。</p>
<img src="/Tripteaz.github.io/2023/01/04/Rendering/HZB_%E9%81%AE%E6%8C%A1%E5%89%94%E9%99%A4%E4%B8%8E%E5%B1%82%E6%AC%A1Z%E7%BC%93%E5%86%B2%EF%BC%88%E4%B8%8A%EF%BC%89%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/hzb0.png" class title="This is an image">



<h4 id="3-动机"><a href="#3-动机" class="headerlink" title="3. 动机"></a>3. 动机</h4><p>动机在于<strong>像素着色次数</strong>，<strong>无效三角形是否被光栅化</strong>，<strong>深度计算和比较深度次数</strong>。</p>
<p>对于back-to-front渲染，对于上图中的10个sphere，会从最后面的sphere开始完整的执行像素着色，对于单个像素而言，中间像素着色10次。</p>
<p>对于front-to-back渲染，尽管省去了重复pixel shading的开销，但10个sphere表面上的三角形仍然经历了光栅化，也依次执行了深度计算的深度测试。</p>
<p>OC的引入使得被遮蔽的物体直接不传入渲染管线，能够规避更多的无谓开销。</p>
<h4 id="4-遮挡剔除算法"><a href="#4-遮挡剔除算法" class="headerlink" title="4. 遮挡剔除算法"></a>4. 遮挡剔除算法</h4><h5 id="4-1-可见性判断划分"><a href="#4-1-可见性判断划分" class="headerlink" title="4.1 可见性判断划分"></a>4.1 可见性判断划分</h5><p>根据viewing location形式来划分，对于可见性的确定可以是<strong>point-based</strong>的，也可以是<strong>cell-based</strong>的。</p>
<img src="/Tripteaz.github.io/2023/01/04/Rendering/HZB_%E9%81%AE%E6%8C%A1%E5%89%94%E9%99%A4%E4%B8%8E%E5%B1%82%E6%AC%A1Z%E7%BC%93%E5%86%B2%EF%BC%88%E4%B8%8A%EF%BC%89%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/hzb1.png" class title="This is an image">



<p>point-based visibility仅考虑单个的viewing location，cell-based visibility考虑的是viewing locations的集合，视点在集合中的任意位置时是否可见。</p>
<p>cell-based的用途是得到的结果可以供多帧来使用，只要viewer还在cell内，但因为计算过程较为耗时，如果使用一般作为预处理步骤（preprocessing step）。</p>
<h5 id="4-2-通用算法流程"><a href="#4-2-通用算法流程" class="headerlink" title="4.2 通用算法流程"></a>4.2 通用算法流程</h5><p>初始化occlusion representation，记为O，存有遮蔽信息。</p>
<p>对于场景中的每个物体g：</p>
<p>进行可见性测试（visibility test），如果不可见，忽略；如果可见，把g送入渲染流程，将g添加到potential occluders集合P。</p>
<p>每当P中potential occluders达到一定数量，将其中元素的遮蔽信息merge到O（这样P中的每个物体也成为了occluder）。</p>
<h5 id="4-3-Tips"><a href="#4-3-Tips" class="headerlink" title="4.3 Tips"></a>4.3 Tips</h5><p>绘制顺序对最终性能表现有影响，最好是先sorting，再front-to-back绘制。</p>
<p>由于距离的影响，很小的object也可能成为巨大的occluder（一叶障目）。</p>
<h4 id="5-GPU对OC的支持（Occlusion-Query）"><a href="#5-GPU对OC的支持（Occlusion-Query）" class="headerlink" title="5. GPU对OC的支持（Occlusion Query）"></a>5. GPU对OC的支持（Occlusion Query）</h4><h5 id="5-1-用户向GPU询问什么"><a href="#5-1-用户向GPU询问什么" class="headerlink" title="5.1 用户向GPU询问什么"></a>5.1 用户向GPU询问什么</h5><p>一个三角形集合（对比当前z-buffer）是否可见。这里的三角形通常指物体的bounding volume，如果这些三角形都不可见（实际上一般是<strong>三角形所占的像素数量n&lt;某阈值</strong>，这个n也可以用来决定物体的LOD），那么包围的物体就可以被剔除。</p>
<h5 id="5-2-GPU在这一过程中做了什么"><a href="#5-2-GPU在这一过程中做了什么" class="headerlink" title="5.2 GPU在这一过程中做了什么"></a>5.2 GPU在这一过程中做了什么</h5><p>将query的（组成BV的）三角形集合光栅化，将它们的深度与z-buffer比较（因此操作是在<strong>image space</strong>中完成的，也是后面HZB的基础）。</p>
<h5 id="5-3-Gain-Cost"><a href="#5-3-Gain-Cost" class="headerlink" title="5.3 Gain-Cost"></a>5.3 Gain-Cost</h5><p>如果结果是将物体剔除，那么收益来自于将此物体从渲染管线中排除，如果结果是物体可见，那么多了此次检测的开销，这自然引入一个问题：什么时候”值得“query。</p>
<h5 id="5-4-什么时候”值得“query"><a href="#5-4-什么时候”值得“query" class="headerlink" title="5.4 什么时候”值得“query"></a>5.4 什么时候”值得“query</h5><p>通常一次query的latency时间大概可渲染数百至数千的三角形，当一个bounding volume包含大量的物体并且有相对较多数量的遮蔽发生时，Gain-to-Cost会更高。</p>
<h5 id="5-5-GPU的-occlusion-query-model"><a href="#5-5-GPU的-occlusion-query-model" class="headerlink" title="5.5 GPU的 occlusion query model"></a>5.5 GPU的 occlusion query model</h5><p>CPU发送任意数量的query，然后CPU周期性检查是否获得query结果，这一过程是异步的。GPU在这一过程执行query并将结果放到一个队列，由CPU去查询结果。DX和GL提供的occlusion query接口是predicated&#x2F;conditional的，query和draw call ID一起提交，如果结果是可见的，GPU自动处理draw call。</p>
<h5 id="5-6-优化"><a href="#5-6-优化" class="headerlink" title="5.6 优化"></a>5.6 优化</h5><p>Occlusion Query其实应该施加在更可能被遮蔽的那些物体上，类似于局部性原理，通常认为可见的倾向于保持可见，这些物体可降低检测频率（temporally jittered sampling），不可见的倾向于保持不可见，这类物体每帧执行检测。</p>
<p>occlusion query batching同时将一个大的BV细分。</p>
<h4 id="6-层次Z缓冲"><a href="#6-层次Z缓冲" class="headerlink" title="6. 层次Z缓冲"></a>6. 层次Z缓冲</h4><p>层次Z缓冲的实现基于GPU的Occlusion Query，因此也是在image space中完成。</p>
<h5 id="6-1-数据准备"><a href="#6-1-数据准备" class="headerlink" title="6.1 数据准备"></a>6.1 数据准备</h5><p>主要包括将场景模型保存在八叉树和z-pyramid构建。</p>
<p>在HZB中，场景模型保存在一个八叉树中，算法中遍历的单位是octree node。</p>
<img src="/Tripteaz.github.io/2023/01/04/Rendering/HZB_%E9%81%AE%E6%8C%A1%E5%89%94%E9%99%A4%E4%B8%8E%E5%B1%82%E6%AC%A1Z%E7%BC%93%E5%86%B2%EF%BC%88%E4%B8%8A%EF%BC%89%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/hzb2.png" class title="This is an image">

<p><strong>z-pyramid</strong>是指将一帧的z-buffer处理为一个图像金字塔（image pyramid），z-pyramid有层次概念，最高分辨率级别（finest level）其实就是标准的z-buffer，也就是金字塔底，然后向上依次降低分辨率，注意处理的方式并不是取平均，而是取2x2网格中的深度最大值（要这样设定的<strong>原因</strong>是，检测时会优先在低分辨率层级，也就是趋近金字塔顶的层级执行，在低分辨率层级中记录2x2网格最深的值，递推到金字塔顶，记录下来的就是最深的几个值，如果box的最近点比这个还远说明被遮蔽，向下检测同理），每当z-buffer中的z-value被覆写时，要沿z-pyramid的各个level递归传递更新。</p>
<img src="/Tripteaz.github.io/2023/01/04/Rendering/HZB_%E9%81%AE%E6%8C%A1%E5%89%94%E9%99%A4%E4%B8%8E%E5%B1%82%E6%AC%A1Z%E7%BC%93%E5%86%B2%EF%BC%88%E4%B8%8A%EF%BC%89%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/hzb3.png" class title="This is an image">

<h5 id="6-2-场景中遮挡区域的层次剔除"><a href="#6-2-场景中遮挡区域的层次剔除" class="headerlink" title="6.2 场景中遮挡区域的层次剔除"></a>6.2 场景中遮挡区域的层次剔除</h5><p>这一步的作用是让后续的测试能使用之前已渲染物体的遮蔽信息。</p>
<p>由于场景模型已保存在八叉树中，场景中遮挡区域的层次剔除由此八叉树支持。</p>
<p>以front-to-back方式遍历八叉树节点。</p>
<p>box投影到屏幕取最近点z<del>near</del>，和z-pyramid最顶（低分辨率）的层级单元比较深度，如果z<del>near</del>深度值更大，便可确定box被遮蔽。</p>
<p>终止条件是确定box被遮蔽，或者已经找到金子塔底box仍可见。</p>
<p>如果最终几何体确定是潜在可见的，那么渲染到hierarchical z-buffer（见上文4.2）</p>
<h5 id="6-3-HZB流程"><a href="#6-3-HZB流程" class="headerlink" title="6.3 HZB流程"></a>6.3 HZB流程</h5><p><strong>用已有遮蔽信息（z-buffer）生成z-pyramid</strong>，初始的遮蔽信息可由“best” occluders提供，什么是“best”呢，一般选择<strong>最近的n个</strong>objects组成的集合，或者<strong>人工生成</strong>的occluder primitives，或者使用<strong>上一帧</strong>的可视物信息（见6.2）。</p>
<p><strong>将物体的BV</strong>（通常用AABB, OBB, sphere）<strong>投影到screen space，根据公式估计对应的z-pyramid等级</strong>。投影后的最长边用于确定mip level，n代表总mip数，l是投影最长边长度（screen space）。</p>
<img src="/Tripteaz.github.io/2023/01/04/Rendering/HZB_%E9%81%AE%E6%8C%A1%E5%89%94%E9%99%A4%E4%B8%8E%E5%B1%82%E6%AC%A1Z%E7%BC%93%E5%86%B2%EF%BC%88%E4%B8%8A%EF%BC%89%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/hzb4.png" class title="This is an image">

<p>经过公式确定的层级，能够保证BV在相应的mip里最多覆盖2*2个深度值。</p>
<p>确定完要使用的z-pyramid层级后，<strong>用BV的z<del>min</del>（BV的最小深度值）和所覆盖的深度值（最多四个）比较，如果z<del>min</del>比所有值都大，被遮蔽</strong>。<strong>否则（z<del>min</del>比任一值小），不被遮蔽，需要渲染</strong>。</p>
<p>此外可以添加<strong>额外验证</strong>提高结果准确度，方法是存一个与一般z-pyramid恰好相反的，每层记录深度<strong>最小值</strong>的buffer，用z<del>max</del>和此buffer这一层对应位置上的各个深度比较，如果z<del>max</del>小于所有这些深度，那么是可见的。如果两次测试的结果（可见or不可见）不同，建议在更高分辨率级别继续测试。</p>
<h5 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h5><p>Real-Time Rendering 4th Edition</p>
<p>Hierarchical Z-Buffer Visibility. Proceedings of SIGGRAPH ‘93. <em>Published February 1, 1993</em>. N. Greene, M. Kass, Gavin Miller.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chasencenge.github.io/Tripteaz.github.io/2023/01/04/Rendering/HZB_%E9%81%AE%E6%8C%A1%E5%89%94%E9%99%A4%E4%B8%8E%E5%B1%82%E6%AC%A1Z%E7%BC%93%E5%86%B2%EF%BC%88%E4%B8%8A%EF%BC%89%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/" data-id="clche78dn00013gypdv7g5olt" data-title="【Rendering】 遮挡剔除与层次Z缓冲（上）——原理篇" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/Tripteaz.github.io/categories/Essay/">Essay</a></li><li class="category-list-item"><a class="category-list-link" href="/Tripteaz.github.io/categories/Math/">Math</a></li><li class="category-list-item"><a class="category-list-link" href="/Tripteaz.github.io/categories/Rendering/">Rendering</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/Tripteaz.github.io/categories/Rendering/Theory/">Theory</a></li></ul></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/Tripteaz.github.io/archives/2023/01/">January 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/Tripteaz.github.io/2023/01/10/Essay/CD_JH_204/">CD_JH_204</a>
          </li>
        
          <li>
            <a href="/Tripteaz.github.io/2023/01/07/Essay/CD_JH_207/">CD_JH_207</a>
          </li>
        
          <li>
            <a href="/Tripteaz.github.io/2023/01/05/Essay/CD_JH_208/">CD_JH_208</a>
          </li>
        
          <li>
            <a href="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%B8%80%EF%BC%89/">【Math】 游戏数学之Linear Algebra（一）</a>
          </li>
        
          <li>
            <a href="/Tripteaz.github.io/2023/01/04/Math/LA_%E6%B8%B8%E6%88%8F%E6%95%B0%E5%AD%A6%E4%B9%8BLinearAlgebra%EF%BC%88%E4%BA%8C%EF%BC%89/">【Math】 游戏数学之Linear Algebra（二）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 CHAsencenge<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/Tripteaz.github.io/" class="mobile-nav-link">Home</a>
  
    <a href="/Tripteaz.github.io/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/Tripteaz.github.io/js/jquery-3.4.1.min.js"></script>



  
<script src="/Tripteaz.github.io/fancybox/jquery.fancybox.min.js"></script>




<script src="/Tripteaz.github.io/js/script.js"></script>





  </div>
</body>
</html>